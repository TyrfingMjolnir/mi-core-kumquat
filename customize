#!/usr/bin/bash
#
# Put customizations to your image in this file.

KUMQUAT_VERSION='0.1.0'

PATH=/opt/local/gnu/bin:/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

# Exit if any commands fail
set -o errexit

# Configuring image specific packages
echo "* Configuring image specific packages."
mkdir -p /opt/kumquat

# Download and extract kumquat to /opt/kumquat
echo "* Download and extract kumquat to /opt/kumquat"
curl -L "https://github.com/wiedi/kumquat/archive/v${KUMQUAT_VERSION}.tar.gz" | tar xz -C /opt/kumquat --strip-components=1

# Setup permissions for kumquat folder
echo "* Setup permissions for kumquat folder"
chown -R www:www /opt/kumquat

# Install missing dependencies via pip
echo "* Install missing dependencies via pip"
pip install django-bootstrap3

# Setup uwsgi and nginx
echo "* Setup uwsgi and nginx"
mkdir -p /opt/local/etc/uwsgi
svccfg import /tmp/uwsgi.xml

# Remove unused httpd config files
echo "* Remove unused httpd config files"
HTTPD_CONF_RM="httpd-autoindex.conf
httpd-dav.conf
httpd-default.conf
httpd-info.conf
httpd-languages.conf
httpd-manual.conf
httpd-mpm.conf
httpd-multilang-errordoc.conf
httpd-ssl.conf
httpd-userdir.conf
httpd-vhosts.conf"

for CONF_RM in ${HTTP_CONF_RM}; do
	rm -f /opt/local/etc/httpd/${CONF_RM}
done

# Remove unused mysql stuff from base
echo "* Remove unused mysql stuff from base"
rm -r /var/mysql/*

# Copy phpmyadmin example config
echo "* Copy phpmyadmin example config"
cp /opt/local/share/examples/phpmyadmin/apache.conf /opt/local/etc/httpd/conf.d/80-phpmyadmin.conf

# Create ssl folder for httpd
echo "* Create ssl folder for httpd"
mkdir /opt/local/etc/httpd/ssl

echo "* Cleaning up"
rm -rf /root/*
sm-prepare-image -y
