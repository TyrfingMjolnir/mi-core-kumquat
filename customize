#!/usr/bin/bash
#
# Put customizations to your image in this file.

KUMQUAT_VERSION='0.1.22'

PATH=/opt/local/gnu/bin:/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

# Munin plugins
MUNIN_PLUGIN_SRC='/opt/local/lib/munin/plugins'
MUNIN_PLUGIN_DST='/opt/local/etc/munin/plugins'
MUNIN_PLUGINS=(
	'apache_accesses'
	'apache_processes'
	'apache_volume'
	'proftpd'
	'proftpd_bytes'
	'proftpd_count'
	'mysql_queries'
	'mysql_bytes'
)

# Exit if any commands fail
set -o errexit

# Configuring image specific packages
echo "* Configuring image specific packages."
mkdir -p /opt/kumquat

# Download and extract kumquat to /opt/kumquat
echo "* Download and extract kumquat to /opt/kumquat"
curl -L "https://github.com/wiedi/kumquat/archive/v${KUMQUAT_VERSION}.tar.gz" | tar xz -C /opt/kumquat --strip-components=1

# Setup permissions for kumquat folder
echo "* Setup permissions for kumquat folder"
chown -R www:www /opt/kumquat

# Install missing dependencies via pip
echo "* Install missing dependencies via pip"
pip install django django-bootstrap3 django-messagegroups

# Setup gunicorn
echo "* Setup gunicorn"
mkdir -p /opt/local/etc/gunicorn
svccfg import /tmp/gunicorn.xml

# Force our apache version to be installed (because of an SSL memoryleek fix)
echo "* Force our apache version to be installed (because of an SSL memoryleek fix)"
pkg_add -fu http://pkgsrc.smartos.skylime.net/skylime-extra/2014Q2/x86_64/apache-2.4.10nb1.tgz

# Remove unused httpd config files
echo "* Remove unused httpd config files"
HTTPD_CONF_RM="httpd-autoindex.conf
httpd-dav.conf
httpd-default.conf
httpd-info.conf
httpd-languages.conf
httpd-manual.conf
httpd-mpm.conf
httpd-multilang-errordoc.conf
httpd-ssl.conf
httpd-userdir.conf
httpd-vhosts.conf"

for CONF_RM in ${HTTPD_CONF_RM}; do
	rm -f /opt/local/etc/httpd/${CONF_RM}
done

# Create ugly mysql-client symlink and install py27-mysqldb
echo "* Create ugly mysql-client symlink and install py27-mysqldb"
ln -sv /opt/local/lib/libperconaserverclient.so.18 /opt/local/lib/libmysqlclient.so.18
pkg_add -fL http://pkgsrc.smartos.skylime.net/packages/SmartOS/2014Q2/x86_64/All/py27-mysqldb-1.2.5.tgz

# Install proFTPd with MySQL and TLS support
echo "* Install proFTPd with MySQL and TLS support"
pkg_add -fL http://pkgsrc.smartos.skylime.net/skylime-extra/2014Q2/x86_64/proftpd-1.3.4dnb1.tgz

# Remove unused mysql stuff from base
echo "* Remove unused mysql stuff from base"
rm -r /var/mysql/*

# Create ssl folder for httpd
echo "* Create ssl folder for httpd"
mkdir /opt/local/etc/httpd/ssl

# Remove phpMyAdmin setup folder
echo "* Remove phpMyAdmin setup folder"
rm -rf /opt/local/share/phpmyadmin/setup

# Copy default index.html
echo "* Copy default index.html"
cp /tmp/default-index.html /opt/local/share/httpd/htdocs/index.html
rm /tmp/default-index.html

# Copy default (basic) kumquat settings
echo "* Copy default (basic) kumquat settings"
cp /tmp/kumquat-settings.py /opt/kumquat/kumquat_web/settings.py
rm /tmp/kumquat-settings.py

# Copy default proftpd configuration
echo "* Copy default proftpd configuration"
cp /tmp/proftpd.conf /opt/local/etc/proftpd.conf
rm /tmp/proftpd.conf

# Create extra logfile folder for proftpd
echo "* Create extra logfile folder for proftpd"
mkdir /var/log/proftpd

# Activate munin plugins
echo "* Activate munin plugins"
for plugin in "${MUNIN_PLUGINS[@]}"; do
	if [ ! -x ${MUNIN_PLUGIN_SRC}/${plugin} ]; then
		plugin_src=${plugin%_*}_
		[ ! -x ${MUNIN_PLUGIN_SRC}/${plugin_src} ] && \
			plugin_src=${plugin_src%%_*}_
	else
		plugin_src=${plugin}
	fi
	if [[ -x ${MUNIN_PLUGIN_SRC}/${plugin_src} ]]; then
		echo "  ${plugin}"
		ln -sf ${MUNIN_PLUGIN_SRC}/${plugin_src} ${MUNIN_PLUGIN_DST}/${plugin}
	fi
done

echo "* Cleaning up"
rm -rf /root/*
sm-prepare-image -y
